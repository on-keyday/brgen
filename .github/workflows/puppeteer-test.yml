name: brgen-puppeteer-test
on:
  # Allows you to run this workflow manually from the Actions tab on GitHub.
  workflow_call: null
  workflow_dispatch: null

permissions:
  contents: read

jobs:
  puppeteer-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Timeline
        uses: Kesin11/actions-timeline@7c7e0821d38f27460f4a71ef874a1c8cf23602e4 # v2.2.6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Download artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: brgen-web-development
          path: "./web/public"
      - name: Install Dependencies
        run:
          | # see https://github.com/puppeteer/puppeteer/blob/38582e22822674138efa0d3dbe10a22bc0a33cad/docker/Dockerfile#L12
          sudo apt-get update
          sudo apt-get install -yq fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-khmeros fonts-kacst fonts-freefont-ttf dbus dbus-x11

      - name: Fetch rebrgen
        run: |
          chmod +x ./script/fetch_rebrgen.sh
          ./script/fetch_rebrgen.sh
        env:
          GH_TOKEN: ${{ github.token }}

        # temporarily disable puppeteer tests due to flakiness
      - name: Test
        if: false
        run:
          | # see https://chromium.googlesource.com/chromium/src/+/main/docs/security/apparmor-userns-restrictions.md
          echo 0 | sudo tee /proc/sys/kernel/apparmor_restrict_unprivileged_userns
          cd astlib/ast2ts
          tsc || true # allow error
          cd ../../web/public
          cd ../dev
          npm install
          npx vite dev --port 8080 &
          sleep 5
          npm install puppeteer
          tsc || true # allow error
          TEST_ENV=github node test/puppet.mjs
